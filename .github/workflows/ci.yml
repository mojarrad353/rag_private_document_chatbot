name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]

    services:
      redis:
        image: redis:alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "0.4.15"

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          uv sync --all-extras --dev

      - name: Run Black Check
        run: uv run black --check .

      - name: Run Pylint
        run: |
          uv run pylint --fail-under=9 src

      - name: Run Mypy
        run: uv run mypy .

      - name: Run Bandit
        run: uv run bandit -r src

      - name: Run Tests with Coverage
        env:
          OPENAI_API_KEY: "dummy-key-for-ci"
        run: |
          # Check if tests directory exists before running pytest
          if [ -d "tests" ]; then
            uv run pytest --cov-fail-under=85 # coverage options are in pyproject.toml
          else
            echo "No tests directory found, skipping tests"
          fi

  ai-code-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    continue-on-error: true

    steps:
      - uses: anc95/ChatGPT-CodeReview@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_API_ENDPOINT: https://api.openai.com/v1
          MODEL: gpt-5-mini
          LANGUAGE: English
          PROMPT: |
            Please review the code changes in this pull request.
            Focus on logical bugs, edge cases, security risks,
            performance issues, and architectural concerns.
            Do not comment on formatting or style issues as
            those are already handled by automated linters.
          top_p: 1
          temperature: 1
          max_tokens: 4096
          MAX_PATCH_LENGTH: 10000
